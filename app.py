import streamlit as st
import google.generativeai as genai
import base64
import time

# Настройка API
api_key = st.secrets.get('GEMINI_API_KEY')
if not api_key:
    st.error("❌ API ключ не найден. Пожалуйста, настройте GEMINI_API_KEY в секретах Streamlit")
    st.stop()

genai.configure(api_key=api_key)

# Базовый промпт для создания структуры произведения
STRUCTURE_PROMPT = """
Ты - профессиональный писатель и сценарист. На основе предоставленных пользователем данных создай подробную структуру повести.

## Задача:
Создать структуру повести в жанре {genre} с сеттингом: {setting}
{alias_text}

## Требования к структуре:
1. **Структура сюжета** (по канонам "завязка-кульминация-развязка-финал"):
   - Завязка: представление мира и персонажей, начало конфликта (главы 1-2)
   - Кульминация: развитие конфликта, ключевые события (главы 3-6)
   - Развязка: разрешение основных противоречий (главы 7-8)
   - Финал: заключительная часть, выводы (глава 9)

2. **Детальный план глав** (9 глав,  объем каждой главы не менее 8000 слов):
   Для каждой главы укажи:
   - Название главы
   - Действующие лица
   - Синопсис: основные события и конфликты
   - Локации действия
   - Участвующие предметы/артефакты
   - Примерный объем в словах

3. **Персонажи** (для каждого):
   - Имя и краткое описание
   - Характер, мотивация
   - Внутренний конфликт
   - Роль и движущая сила в сюжете
   - Как завершается путь персонажа в сюжете (если применимо)

4. **Локации** - описание ключевых мест действия

5. **Предметы/артефакты** - значимые объекты в сюжете

6. **Краткая концовка** - общее направление финала

Структура должна быть достаточно детальной, чтобы служить основой для написания полного текста повести.

##Какие бывают сюжеты (используй один или несколько из 36 типов для генерации структуры повести):
1.Мольба о заступничестве
Притеснитель; Проситель; Представитель власти, который должен разрешить конфликт.
Проситель молит представителя власти о защите от притеснителя. Проситель может быть представлен в двух лицах - Жертва и Заступник. Пример:Есфирь, которая попросила персидского царя заступиться за еврейский народ и защитить его от происков злого царедворца Амана.
2.Спасение
Невезучий; Угрожающий; Спаситель.
Невезучий стал причиной конфликта и Угрожающий собирается ему отомстить. Но Спаситель приходит на помощь Невезучему. Примеры: Ифигения в Тавриде, Избавление.
3.Преступление и Месть
Преступник; Мститель.
Преступник совершает злодеяние, которое осталось безнаказанным, и Мститель вершит правосудие самостоятельно. Пример: Граф Монте-Кристо.
4.Кровная месть
Виновный Родич, Мстящий Родич, память о Жертве, которая является родственником обеим сторонам.
Родичи вступают в конфликт из-за преступления, совершенного по отношению к Жертве. Пример: Гамлет.
5. Преследование
Беглец; кара
Беглец пытается избегать кары за преступление, которого он не совершал. Примеры: Отверженные, Беглец.
6.Катастрофа
Побежденный, Победитель или Посланец
Побежденный терпит поражение от Победителя или получает послание о таком поражении от Посланца. Пример: Агамемнон.
7.Жертва
Жертва; Хозяин или некое бедствие
Жертва страдает от обстоятельств или от рук Хозяина. Пример: Иов.
8.Бунт
Тиран; Заговорщик
Заговорщик пытается свергнуть тирана. Пример: Юлий Цезарь.
9.Отважная попытка
Отважный лидер; предмет; Враг
Отважный лидер побеждает Врага и забирает у него предмет. Примеры:Ланселот-Грааль, Властелин колец.
10.Похищение
Похититель; Похищенный; Опекун
Похититель увозит Похищенного от Опекуна. Пример: Елена Прекрасная
11.Загадка
Загадка; Вопрошающий; Ответчик
Вопрошающий загадывает загадку Ответчику и предоставляет ему шанс достичь его целей. Примеры: Сфинкс, Эдип.
12.Обретение
Проситель и Владелец или Судья и Претенденты
Проситель вступает в конфликт с Владельцем, который отказывается дать ему предмет спора. Второй вариант: Судья решает кому отдать предмет, о котором спорят несколько Претендентов. Пример: Яблоко раздора
13.Вражда между близкими
Злобный Сородич и Ненавидимый или Сородичи, взаимно ненавидящие друг друга.
Сородичи замышляют друг против друга козни. Или Злобный Сородич старается подсидеть Ненавидимого. Пример: Как вам это понравится
14.Соперничество между близкими
Любимый Сородич; Отвергнутый Сородич; предмет спора.
Предмет спора предпочитает Любимого Сородича Отвергнутому Сородичу. Пример: Грозовой перевал.
15.Адюльтер, сопровождающийся убийством
Любовники; Ненавистный Супруг
Двое Любовников замышляют убить Ненавистного Супруга одного из них. Примеры: Леди Макбет Мценского уезда, Клитемнестра, Эгисф, Двойная страховка.
16.Безумие
Безумец; Жертва.
Безумец сходит с ума и совершает несправедливое действие в отношении Жертвы. Пример: Сияние.
17.Фатальная неосторожность
18.Невольное кровосмешение
19.Невольное убийство близкого
20.Самопожертвование во имя идеала
21.Самопожертвование ради близких
22.Жертвование всем ради страсти
23.Жертва близким во имя долга
24.Соперничество неравных
25.Адюльтер
26.Запретная любовь
Любовник и возлюбленная нарушают табу, завязывая романтические отношения. Пример: Зигмунд и его сестра в Валькирии.
27.Бесчестие любимого существа
28.Любовь, встречающая препятствия
29.Любовь к врагу
30.Честолюбие
31.Борьба против бога
32.Безосновательная ревность
33.Судебная ошибка
34.Угрызения совести
35.Вновь найденный
36.Потеря близких

4 Типа сюжетов по Борхесу:
1.История об осаждённом городе, который штурмуют и обороняют (пример: «Илиада»).
2.История о возвращении (пример: «Одиссея»). Главный герой преодолевает множество препятствий, чтобы вернуться к истокам.
3.История о поиске (пример: «Аргонавты»). В литературе поиск принимает разные формы: одни герои ищут себя, другие — сокровища.
4.История о самоубийстве/самопожертвовании бога (пример: Христос). Главный персонаж стремится стать чем-то большим, чем он есть, познать смысл жизни, спасти мир, и готов пожертвовать собой ради всеобщего блага.
"""

# Промпт для генерации отдельных глав с учетом предыдущего контекста
CHAPTER_PROMPT = """
Ты - профессиональный писатель. Напиши главу повести на основе предоставленной структуры и УЖЕ НАПИСАННЫХ ПРЕДЫДУЩИХ ГЛАВ.

## КОНТЕКСТ ПРОИЗВЕДЕНИЯ:
Жанр: {genre}
Сеттинг: {setting}
{alias_text}

## ПОЛНАЯ СТРУКТУРА ПРОИЗВЕДЕНИЯ:
{structure}

## УЖЕ НАПИСАННЫЕ ПРЕДЫДУЩИЕ ГЛАВЫ:
{previous_chapters}

## ТЕКУЩАЯ ГЛАВА {chapter_number} - ДЕТАЛИ:
{chapter_details}

## КРИТИЧЕСКИ ВАЖНЫЕ ТРЕБОВАНИЯ:
- Объем: примерно {word_count} слов
- Стиль: соответствие жанру {genre}
- Сюжет: НЕ ОТКЛОНЯЙСЯ от полной структуры произведения
- УЧТИ ВСЕ СОБЫТИЯ И ДИАЛОГИ ИЗ ПРЕДЫДУЩИХ ГЛАВ
- ОБЕСПЕЧЬ ПЛАВНЫЕ ПЕРЕХОДЫ И ЛОГИЧЕСКУЮ ПРЕЕМСТВЕННОСТЬ
- Развивай сюжетные линии, начатые в предыдущих главах
- Используй установленные характеры персонажей последовательно
- Развивай конфликты, заложенные ранее
- Используй указанные локации и предметы согласно общей структуре
- Естественные диалоги, учитывающие предыдущие взаимодействия персонажей
- НЕ ЗЛОУПОТРЕБЛЯЙ ДИАЛОГАМИ, БОЛЬШЕ ДЕЙСТВИЯ И ОПИСАНИЙ
- МЕНЬШЕ ШТАМПОВ И КЛИШЕ, БОЛЬШЕ ОРИГИНАЛЬНЫХ ИДЕЙ И НЕОЖИДАННЫХ СЮЖЕТНЫХ ПОВОРОТОВ
- НЕ ВОСПРОИЗВОДИ В ТЕКСТЕ ПРОМПТЫ И СОДЕРЖАНИЕ ПРЕДЫДУЩИХ ГЛАВ
- ИЗБЕГАЙ НЕНУЖНОГО ПАФОСА
- ИЗБЕГАЙ НЕРВОЗНЫХ ПОВТОРЯЮЩИХСЯ ФРАЗ ВРОДЕ 'ОНА СДЕЛАЛА ЭТО', 'ОНА БЫЛА ГОТОВА'

Напиши полный текст главы {chapter_number}, начиная непосредственно с повествования, КОТОРОЕ ЛОГИЧЕСКИ ВЫТЕКАЕТ ИЗ ПРЕДЫДУЩИХ СОБЫТИЙ.
"""

# Промпт для литературного редактора
EDITOR_PROMPT = """
Ты редактируешь художественный текст. Проанализируй представленную главу и перепиши ее, обогатив деталями описания событий, чувств и мыслей персонажей, исправив следующие ошибки:

1. Бредовые повторяющиеся по смыслу реплики персонажей и однотипные фразы, например: 
   '- У нас получилось. Мы смогли. Мы победили.', 
   '- Мы сделали это. Я и ты. Мы оба'. 
   'Она была готова. Он был готов. Они оба были готовы.' 
   заменить на одну фразу, общую по смыслу со всей бредовой цепочкой повторяющихся однотипных фраз.

2. Тривиальные описания событий и поступков без деталей, например: 
   'Он вступил в последний поединок, нанес удар и победил' 
   заменить на расширенное описание с деталями вроде 
   'Он упал навзничь, противник извернулся и решительно со всей силы двинул кулаком в грудь, но вовремя поставленный блок погасил энергию удара, и он, вскочив, сделал ловкую подсечку, повалив противника на землю. Тот затих и перестал двигаться, только пар шел изо рта. Больше он не представлял угрозы.'

3. Трюизмы, тавтологию.

## КОНТЕКСТ ПРОИЗВЕДЕНИЯ:
Жанр: {genre}
Сеттинг: {setting}
{alias_text}

## СТРУКТУРА ПРОИЗВЕДЕНИЯ:
{structure}

## ПРЕДЫДУЩИЕ ГЛАВЫ (для контекста):
{previous_chapters}

## ТЕКУЩАЯ ГЛАВА {chapter_number} ДЛЯ РЕДАКТУРЫ:
{chapter_text}

## ЗАДАЧА:
Перепиши главу, сохраняя сюжет и ключевые события, но улучшая литературное качество:
- Обогати описания деталями
- Углуби психологию персонажей через их мысли и чувства
- Убери повторяющиеся и шаблонные фразы
- Добавь оригинальности и выразительности
- Сохрани общий стиль и тон произведения

Верни только улучшенный текст главы без дополнительных комментариев.
"""

# Промпт для рецензии критика
CRITIQUE_PROMPT = """
Напиши рецензию на мой текст:

{full_story}

Твой тон — строгий, профессиональный, лишенный сентиментальности.
Твой анализ — точный и безжалостный к слабым местам.
Твоя критика всегда конструктивна. Ты не просто указываешь на ошибку, а объясняешь, почему это ошибка, и как её можно исправить.
Для анализа и вынесения вердиктов ты используешь медицинскую, хирургическую или юридическую метафорику (например: "Диагноз: ...", "Протокол вскрытия:", "Вердикт: ..."). 
Поставь тексту оценку от 10 - отлично до 0 - кошмарно.
"""

def generate_structure(genre, setting, alias, temperature):
    """Генерирует структуру повести с заданной температурой"""
    try:
        alias_text = f"Дополнительная идея пользователя: {alias}" if alias else ""
        
        prompt = STRUCTURE_PROMPT.format(
            genre=genre,
            setting=setting,
            alias_text=alias_text
        )
        
        model = genai.GenerativeModel('gemini-2.5-flash')
        
        # Используем настройки генерации с заданной температурой
        generation_config = genai.types.GenerationConfig(
            temperature=temperature,
            top_p=0.8,
            top_k=40
        )
        
        response = model.generate_content(
            prompt,
            generation_config=generation_config
        )
        
        return response.text
    except Exception as e:
        st.error(f"Ошибка при генерации структуры: {str(e)}")
        return None

def generate_chapter(genre, setting, alias, structure, previous_chapters, chapter_number, chapter_details, word_count):
    """Генерирует отдельную главу повести с учетом предыдущих глав (фиксированная температура 0.3)"""
    try:
        alias_text = f"Дополнительная идея пользователя: {alias}" if alias else ""
        
        # Формируем текст предыдущих глав для контекста
        previous_chapters_text = "Это первая глава, предыдущих глав нет." if not previous_chapters else previous_chapters
        
        prompt = CHAPTER_PROMPT.format(
            genre=genre,
            setting=setting,
            alias_text=alias_text,
            structure=structure,
            previous_chapters=previous_chapters_text,
            chapter_number=chapter_number,
            chapter_details=chapter_details,
            word_count=word_count
        )
        
        model = genai.GenerativeModel('gemini-2.0-flash')
        
        # Фиксированные настройки для генерации глав - низкая температура для консистентности
        generation_config = genai.types.GenerationConfig(
            temperature=0.3,  # Низкая температура для последовательности
            top_p=0.7,
            top_k=20
        )
        
        response = model.generate_content(
            prompt,
            generation_config=generation_config
        )
        
        return response.text
    except Exception as e:
        st.error(f"Ошибка при генерации главы {chapter_number}: {str(e)}")
        return None

def literary_edit_chapter(genre, setting, alias, structure, previous_chapters, chapter_number, chapter_text):
    """Редактирует главу с помощью литературного редактора"""
    try:
        alias_text = f"Дополнительная идея пользователя: {alias}" if alias else ""
        
        # Формируем текст предыдущих глав для контекста
        previous_chapters_text = "Это первая глава, предыдущих глав нет." if not previous_chapters else previous_chapters
        
        prompt = EDITOR_PROMPT.format(
            genre=genre,
            setting=setting,
            alias_text=alias_text,
            structure=structure,
            previous_chapters=previous_chapters_text,
            chapter_number=chapter_number,
            chapter_text=chapter_text
        )
        
        model = genai.GenerativeModel('gemini-2.0-flash')
        
        # Настройки для редактора - средняя температура для баланса креативности и сохранения сюжета
        generation_config = genai.types.GenerationConfig(
            temperature=0.5,
            top_p=0.8,
            top_k=30
        )
        
        response = model.generate_content(
            prompt,
            generation_config=generation_config
        )
        
        return response.text
    except Exception as e:
        st.error(f"Ошибка при редактировании главы {chapter_number}: {str(e)}")
        return chapter_text  # Возвращаем оригинальный текст в случае ошибки

def parse_structure_for_chapters(structure_text):
    """Парсит структуру для извлечения информации о главах"""
    # В реальном приложении здесь должна быть сложная логика парсинга структуры
    # Для демонстрации создадим упрощенную структуру глав
    chapters = []
    
    lines = structure_text.split('\n')
    current_chapter = None
    
    for line in lines:
        line = line.strip()
        if line.lower().startswith('глава') or line.lower().startswith('chapter'):
            if current_chapter:
                chapters.append(current_chapter)
            current_chapter = {"title": line, "details": ""}
        elif current_chapter and line:
            current_chapter["details"] += line + "\n"
    
    if current_chapter:
        chapters.append(current_chapter)
    
    # Если не удалось распарсить, создаем базовую структуру
    if not chapters:
        chapters = [
            {"title": "Глава 1: Начало пути", "details": "Знакомство с главным героем и миром"},
            {"title": "Глава 2: Первые испытания", "details": "Герой сталкивается с первыми трудностями"},
            {"title": "Глава 3: Развитие конфликта", "details": "Углубление основных противоречий"},
            {"title": "Глава 4: Поворотный момент", "details": "Ключевое событие, меняющее ход истории"},
            {"title": "Глава 5: Нарастание напряжения", "details": "Ситуация усложняется"},
            {"title": "Глава 6: Кризис", "details": "Герой оказывается в сложнейшем положении"},
            {"title": "Глава 7: Решение", "details": "Герой находит путь к разрешению конфликта"},
            {"title": "Глава 8: Кульминация", "details": "Развязка основных событий"},
            {"title": "Глава 9: Финал", "details": "Завершение истории, выводы"}
        ]
    
    return chapters

def generate_critique(full_story):
    """Генерирует рецензию от беспощадного критика"""
    try:
        prompt = CRITIQUE_PROMPT.format(full_story=full_story)
        
        model = genai.GenerativeModel('gemini-2.0-flash')
        
        generation_config = genai.types.GenerationConfig(
            temperature=0.7,  # Средняя температура для баланса строгости и креативности
            top_p=0.8,
            top_k=40
        )
        
        response = model.generate_content(
            prompt,
            generation_config=generation_config
        )
        
        return response.text
    except Exception as e:
        st.error(f"Ошибка при генерации рецензии: {str(e)}")
        return None

def main():
    st.set_page_config(
        page_title="Графоманъ: Генератор повестей",
        page_icon="📖",
        layout="wide"
    )
    
    st.title("📖 Графоманъ: Генератор повестей")
    st.markdown("Создавайте увлекательные повести в заданном жанре и сеттинге")
    
    # Инициализация session_state
    if 'current_step' not in st.session_state:
        st.session_state.current_step = 1  # 1: параметры, 2: генерация, 3: результат
    
    if 'full_story' not in st.session_state:
        st.session_state.full_story = ""
    
    if 'edited_story' not in st.session_state:
        st.session_state.edited_story = ""  # Для хранения отредактированной версии
    
    if 'critique' not in st.session_state:
        st.session_state.critique = None
    
    if 'is_generating_critique' not in st.session_state:
        st.session_state.is_generating_critique = False
    
    # Шаг 1: Параметры повести
    if st.session_state.current_step == 1:
        st.header("1. Параметры повести")
        
        col1, col2 = st.columns(2)
        
        with col1:
            genre = st.text_input(
                "Жанр произведения:",
                placeholder="например: фэнтези, научная фантастика, детектив, роман...",
                help="Укажите основной жанр вашей повести"
            )
        
        with col2:
            setting = st.text_input(
                "Сеттинг (место и время действия):",
                placeholder="например: средневековое королевство, космическая станция в 2250 году...",
                help="Опишите мир, в котором происходит действие"
            )
        
        # Ползунок фантазии
        st.header("2. Настройки творчества")
        
        creativity = st.slider(
            "Уровень фантазии писателя:",
            min_value=0.1,
            max_value=1.0,
            value=0.7,
            step=0.1,
            help=(
                "Низкое значение = более предсказуемый сюжет, строгое следование жанру\n"
                "Высокое значение = более креативный и неожиданный сюжет, возможны смешения жанров"
            )
        )
        
        # Отображаем пояснение к уровню фантазии
        creativity_descriptions = {
            0.1: "🤖 Максимальная предсказуемость - строгое следование канонам жанра",
            0.2: "📚 Консервативный подход - минимальные отклонения от стандартов",
            0.3: "📝 Умеренный реализм - баланс между традиционностью и творчеством", 
            0.4: "🎭 Сбалансированный - классический подход с элементами новизны",
            0.5: "✨ Стандартная креативность - хороший баланс предсказуемости и неожиданностей",
            0.6: "🌟 Творческий - заметные элементы оригинальности в сюжете",
            0.7: "🚀 Высокая фантазия - значительные творческие отклонения от шаблонов",
            0.8: "🎨 Очень креативный - смелые сюжетные повороты и нестандартные решения",
            0.9: "🔥 Экспериментальный - высокий уровень неожиданных событий",
            1.0: "⚡ Максимальная креативность - полностью оригинальный и непредсказуемый сюжет"
        }
        
        # Показываем описание для текущего значения
        current_description = creativity_descriptions.get(creativity, "Сбалансированный подход")
        st.info(f"**Текущий уровень:** {current_description}")
        
        st.header("3. Дополнительная идея (опционально)")
        alias = st.text_area(
            "Дополнительная идея или концепция:",
            height=100,
            placeholder="например: история о программисте, попавшем в мир магии, где технологии заменяют заклинания...",
            help="Любые дополнительные пожелания или идеи для сюжета"
        )
        
        # Сохраняем параметры в session_state
        st.session_state.genre = genre
        st.session_state.setting = setting
        st.session_state.creativity = creativity
        st.session_state.alias = alias
        
        # Кнопка перехода к генерации
        if st.button("🎭 Начать создание повести", type="primary"):
            if not genre or not setting:
                st.warning("⚠️ Пожалуйста, заполните жанр и сеттинг")
            else:
                st.session_state.current_step = 2
                st.rerun()
    
    # Шаг 2: Генерация повести
    elif st.session_state.current_step == 2:
        genre = st.session_state.genre
        setting = st.session_state.setting
        creativity = st.session_state.creativity
        alias = st.session_state.alias
        
        st.header("🔄 Генерация повести")
        st.info(f"**Параметры:** Жанр: {genre}, Сеттинг: {setting}, Фантазия: {creativity}")
        
        # Генерация структуры
        with st.spinner("📐 Создаю структуру произведения..."):
            structure = generate_structure(genre, setting, alias, creativity)
            
            if not structure:
                st.error("❌ Не удалось создать структуру произведения")
                if st.button("🔄 Попробовать снова"):
                    st.rerun()
                return
            
            st.success("✅ Структура произведения создана!")
            
            # Отображаем структуру
            st.divider()
            st.header("📋 Структура произведения")
            st.text_area("Структура:", structure, height=400, key="structure")
        
        # Парсим структуру для получения информации о главах
        chapters_info = parse_structure_for_chapters(structure)
        
        # Генерация глав
        st.divider()
        st.header("🖋️ Написание глав")
        st.info("📝 Главы генерируются с фиксированной температурой 0.3 для сохранения последовательности сюжета")
        
        full_story = ""
        edited_story = ""  # Для хранения отредактированной версии
        progress_bar = st.progress(0)
        status_text = st.empty()
        chapter_display = st.empty()
        
        chapters_count = len(chapters_info)
        words_per_chapter = 8000  # Примерный объем на главу
        
        for chapter_num in range(chapters_count):
            status_text.text(f"Пишу главу {chapter_num + 1} из {chapters_count}...")
            
            # Получаем информацию о текущей главе
            chapter_info = chapters_info[chapter_num]
            chapter_details = f"{chapter_info['title']}\n{chapter_info['details']}"
            
            # Показываем текущую главу в интерфейсе
            with chapter_display.container():
                st.subheader(f"Глава {chapter_num + 1}: {chapter_info['title']}")
                st.write(chapter_info['details'])
            
            # Генерируем главу с учетом предыдущего контекста
            chapter_text = generate_chapter(
                genre, setting, alias, structure, 
                full_story,  # Передаем все предыдущие главы как контекст
                chapter_num + 1, 
                chapter_details, 
                words_per_chapter
            )
            
            if chapter_text:
                # Отправляем главу на литературное редактирование
                with st.spinner(f"✏️ Редактирую главу {chapter_num + 1}..."):
                    edited_chapter_text = literary_edit_chapter(
                        genre, setting, alias, structure,
                        full_story,  # Контекст предыдущих глав
                        chapter_num + 1,
                        chapter_text
                    )
                
                # Добавляем оригинальную главу к полному тексту (для контекста следующей генерации)
                full_story += f"\n\nГЛАВА {chapter_num + 1}: {chapter_info['title']}\n\n{chapter_text}"
                
                # Добавляем отредактированную главу к финальному тексту
                edited_story += f"\n\nГЛАВА {chapter_num + 1}: {chapter_info['title']}\n\n{edited_chapter_text}"
                
                st.success(f"✅ Глава {chapter_num + 1} завершена и отредактирована")
            else:
                st.error(f"❌ Ошибка при написании главы {chapter_num + 1}")
                break
            
            progress_bar.progress((chapter_num + 1) / chapters_count)
        
        # Сохраняем полную историю и переходим к шагу 3
        if edited_story.strip():
            st.session_state.full_story = full_story  # Оригинальная версия
            st.session_state.edited_story = edited_story  # Отредактированная версия
            st.session_state.current_step = 3
            st.success("🎉 Повесть успешно создана и отредактирована!")
            st.rerun()
    
    # Шаг 3: Результат и рецензия
    elif st.session_state.current_step == 3:
        st.header("📘 Готовая повесть")
        
        # Переключатель между оригинальной и отредактированной версией
        version = st.radio(
            "Выберите версию для просмотра:",
            ["📝 Отредактированная версия (рекомендуется)", "⚪ Оригинальная версия"],
            index=0
        )
        
        # Выбираем какую версию показывать
        display_story = st.session_state.edited_story if version.startswith("📝") else st.session_state.full_story
        
        # Отображаем полную повесть
        st.text_area("Полный текст повести:", display_story, height=600, key="full_story_display")
        
        # Статистика
        word_count = len(display_story.split())
        st.sidebar.header("📊 Статистика")
        st.sidebar.write(f"Общий объем: {word_count} слов")
        st.sidebar.write(f"Уровень фантазии: {st.session_state.creativity}")
        st.sidebar.write(f"Версия: {'Отредактированная' if version.startswith('📝') else 'Оригинальная'}")
        
        # Кнопки экспорта
        st.divider()
        st.header("💾 Экспорт результата")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # Скачивание как TXT
            b64_txt = base64.b64encode(display_story.encode()).decode()
            version_suffix = "_отредактированная" if version.startswith("📝") else "_оригинальная"
            href_txt = f'<a href="data:file/txt;base64,{b64_txt}" download="повесть_{st.session_state.genre}{version_suffix}.txt">📥 Скачать как TXT</a>'
            st.markdown(href_txt, unsafe_allow_html=True)
        
        with col2:
            # Копирование в буфер обмена
            if st.button("📋 Скопировать в буфер обмена", key="copy_full"):
                st.code(display_story, language="markdown")
                st.success("Текст скопирован в буфер обмена!")

        # Рецензия от критика
        st.divider()
        st.header("🎯 Рецензия от Беспощадного Критика")
        
        # Если рецензия уже сгенерирована, показываем ее
        if st.session_state.critique:
            st.subheader("Рецензия от Беспощадного Критика")
            st.text_area("", st.session_state.critique, height=400, key="critique_display")
            
            # Кнопка для копирования рецензии
            if st.button("📋 Скопировать рецензию", key="copy_critique"):
                st.code(st.session_state.critique, language="markdown")
                st.success("Рецензия скопирована в буфер обмена!")
            
            # Кнопка для обновления рецензии
            if st.button("🔄 Обновить рецензию", key="refresh_critique"):
                st.session_state.critique = None
                st.session_state.is_generating_critique = False
                st.rerun()
        
        # Если рецензия генерируется
        elif st.session_state.is_generating_critique:
            with st.spinner("🔍 Критик анализирует произведение... Это может занять несколько минут"):
                # Используем отредактированную версию для рецензии
                critique = generate_critique(st.session_state.edited_story)
                if critique:
                    st.session_state.critique = critique
                    st.session_state.is_generating_critique = False
                    st.success("✅ Рецензия готова!")
                    st.rerun()
                else:
                    st.error("❌ Не удалось получить рецензию")
                    st.session_state.is_generating_critique = False
                    st.rerun()
        
        # Если рецензия еще не запрашивалась
        else:
            st.info("""
            **Получите профессиональную рецензию на вашу повесть:**
            - Строгий анализ сильных и слабых сторон
            - Конструктивные рекомендации по улучшению
            - Оценка по 10-балльной шкале
            - Профессиональная критика с медицинской/юридической метафорикой
            """)
            
            if st.button("📝 Получить рецензию от Беспощадного Критика", type="secondary"):
                st.session_state.is_generating_critique = True
                st.rerun()
        
        # Кнопка для создания новой повести
        st.divider()
        if st.button("🔄 Создать новую повесть", type="primary"):
            # Сбрасываем состояние, но сохраняем параметры для удобства
            st.session_state.current_step = 1
            st.session_state.full_story = ""
            st.session_state.edited_story = ""
            st.session_state.critique = None
            st.session_state.is_generating_critique = False
            st.rerun()

    # Информационная панель
    st.sidebar.header("🎛️ Настройки генерации")
    st.sidebar.info("""
    **Температура генерации:**
    - **Структура:** регулируется ползунком (0.1-1.0)
    - **Главы:** фиксированная 0.3 для консистентности
    - **Редактор:** фиксированная 0.5 для баланса
    
    🔥 Высокая температура = больше креативности
    ❄️ Низкая температура = больше предсказуемости
    """)
    
    st.sidebar.header("ℹ️ О приложении")
    st.sidebar.info("""
    **Генератор повестей** создает литературные произведения 
    на основе заданных параметров.
    
    **Как использовать:**
    1. Укажите жанр и сеттинг
    2. Настройте уровень фантазии
    3. Добавьте дополнительную идею (по желанию)
    4. Нажмите "Начать создание повести"
    5. Получите структуру и полный текст
    
    **Процесс создания:**
    - Структура: настраиваемая температура (креативность)
    - Главы: фиксированная температура 0.3 (последовательность)
    - Литературный редактор: улучшает качество текста
    - Каждая глава учитывает предыдущие для целостности
    - Общий объем главы: ~8000+ слов
    """)

if __name__ == "__main__":
    main()
