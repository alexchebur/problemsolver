import streamlit as st
import google.generativeai as genai
import base64
import time
from docx import Document
import io
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API
api_key = st.secrets.get('GEMINI_API_KEY')
if not api_key:
    st.error("‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ GEMINI_API_KEY –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö Streamlit")
    st.stop()

genai.configure(api_key=api_key)

# –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∂–∞–ª–æ–±—ã
FACTUAL_CIRCUMSTANCES_PROMPT = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–≤–µ. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤—å —Ä–∞–∑–¥–µ–ª –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–µ–ª–∞".

## –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´:
{context}

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ê–ó–î–ï–õ–£:
1. –ö—Ä–∞—Ç–∫–æ –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –∏–∑–ª–æ–∂–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–µ–ª–∞
2. –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã, —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
3. –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–µ–ª–∞ (–∫–∞–∫–∏–µ —Å—É–¥—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏, –∫–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω—è–ª–∏)
4. –£–∫–∞–∂–∏—Ç–µ –Ω–∞ –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ —Å—É–¥–µ–±–Ω—ã–µ –∞–∫—Ç—ã –ø–æ–¥–∞–µ—Ç—Å—è –∂–∞–ª–æ–±–∞
5. –ò–∑–±–µ–≥–∞–π –æ—Ü–µ–Ω–æ–∫ –∏ –ø—Ä–∞–≤–æ–≤—ã—Ö –≤—ã–≤–æ–¥–æ–≤ –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ
6. –°–æ–±–ª—é–¥–∞–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å
7. –ò—Å–ø–æ–ª—å–∑—É–π —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
"""

LEGAL_ISSUES_PROMPT = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–≤–µ. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤—å —Ä–∞–∑–¥–µ–ª –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã "–ü—Ä–∞–≤–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ –¥–µ–ª–∞".

## –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´:
{context}

## –£–ñ–ï –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –†–ê–ó–î–ï–õ–´:
{generated_parts}

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ê–ó–î–ï–õ–£:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–∞–≤–æ–≤—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—è
2. –í—ã—è–≤–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è –Ω–æ—Ä–º –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –∏ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–∞
3. –£–∫–∞–∂–∏ –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–∞
4. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ—Å—Ç–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏—è
5. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–∑–∏—Ü–∏–∏ –í–° –†–§ –∏ –ø—Ä–∞–≤–æ–≤—É—é –¥–æ–∫—Ç—Ä–∏–Ω—É
6. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è (–µ—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã)
7. –í—ã—è–≤–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ —Å—É–¥–µ–±–Ω—ã—Ö –∞–∫—Ç–∞—Ö

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
"""

APPLICANT_POSITION_PROMPT = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–≤–µ. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤—å —Ä–∞–∑–¥–µ–ª –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã "–ü—Ä–∞–≤–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –∑–∞—è–≤–∏—Ç–µ–ª—è".

## –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´:
{context}

## –£–ñ–ï –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –†–ê–ó–î–ï–õ–´:
{generated_parts}

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ê–ó–î–ï–õ–£:
1. –ò–∑–ª–æ–∂–∏ –ø—Ä–∞–≤–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –∑–∞—è–≤–∏—Ç–µ–ª—è
2. –û—Ü–µ–Ω–∏ –Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ—Å—Ç—å –¥–æ–≤–æ–¥–æ–≤ —Å—É–¥–µ–±–Ω—ã—Ö –∞–∫—Ç–æ–≤
3. –û–±–æ—Å–Ω—É–π –ø–æ—á–µ–º—É —Å—É–¥–µ–±–Ω—ã–µ –∞–∫—Ç—ã –ø–æ–¥–ª–µ–∂–∞—Ç –æ—Ç–º–µ–Ω–µ
4. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞—è–≤–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã)
5. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –í–° –†–§
6. –ü–æ–∫–∞–∂–∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥–æ–ø—É—â–µ–Ω–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π
7. –û–±–æ—Å–Ω—É–π –ø–æ—á–µ–º—É –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥ –¥–µ–ª–∞

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
"""

PETITIONARY_PART_PROMPT = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–≤–µ. –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤—å –ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã.

## –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´:
{context}

## –£–ñ–ï –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –†–ê–ó–î–ï–õ–´:
{generated_parts}

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ü–†–û–°–ò–¢–ï–õ–¨–ù–û–ô –ß–ê–°–¢–ò:
1. –ß–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –í–µ—Ä—Ö–æ–≤–Ω–æ–º—É —Å—É–¥—É –†–§
2. –£–∫–∞–∂–∏ –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ —Å—É–¥–µ–±–Ω—ã–µ –∞–∫—Ç—ã –ø–æ–¥–ª–µ–∂–∞—Ç –æ—Ç–º–µ–Ω–µ
3. –ü—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–µ–ª–∞ (–ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤–æ–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∏ —Ç.–¥.)
4. –°–æ–±–ª—é–¥–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±–µ
5. –£–∫–∞–∂–∏ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ö–ê–° –†–§/–ê–ü–ö –†–§

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
"""

CHAT_PROMPT = """
–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º—É –ø—Ä–∞–≤—É. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –¥–µ–ª—É –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏–∏.

## –î–û–ö–£–ú–ï–ù–¢–´ –ü–û –î–ï–õ–£:
{context}

## –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–ê–Ø –ñ–ê–õ–û–ë–ê:
{complaint_text}

## –ò–°–¢–û–†–ò–Ø –ß–ê–¢–ê:
{chat_history}

## –¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{user_question}

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
1. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. –ò—Å–ø–æ–ª—å–∑—É–π —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é
3. –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–ª–∏ —á–∞—Å—Ç–∏ –∂–∞–ª–æ–±—ã
5. –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º —è–∑—ã–∫–æ–º
6. –ü–æ–º–æ–≥–∞–π —Å –¥–æ—Ä–∞–±–æ—Ç–∫–æ–π –∂–∞–ª–æ–±—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–± —ç—Ç–æ–º –ø—Ä–æ—Å–∏—Ç

–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç.
"""

def read_docx(file):
    """–ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ DOCX"""
    try:
        doc = Document(file)
        text = []
        for paragraph in doc.paragraphs:
            if paragraph.text.strip():
                text.append(paragraph.text)
        return '\n'.join(text)
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {file.name}: {str(e)}")
        return ""

def extract_text_from_uploaded_files(uploaded_files):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"""
    context_parts = []
    
    for uploaded_file in uploaded_files:
        if uploaded_file.name.endswith('.docx'):
            text = read_docx(uploaded_file)
            context_parts.append(f"--- –î–û–ö–£–ú–ï–ù–¢: {uploaded_file.name} ---\n{text}")
        else:
            st.warning(f"–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ {uploaded_file.name} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .docx —Ñ–∞–π–ª—ã.")
    
    return "\n\n".join(context_parts)

def generate_complaint_part(prompt_template, context, generated_parts, temperature=0.3):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–∞—Å—Ç—å –∂–∞–ª–æ–±—ã —Å –ø–æ–º–æ—â—å—é Gemini API"""
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt = prompt_template.format(
            context=context,
            generated_parts=generated_parts
        )
        
        model = genai.GenerativeModel('gemini-2.0-flash-lite')
        
        generation_config = genai.types.GenerationConfig(
            temperature=temperature,
            top_p=0.8,
            top_k=40
        )
        
        response = model.generate_content(
            prompt,
            generation_config=generation_config
        )
        
        return response.text
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–∞—Å—Ç–∏ –∂–∞–ª–æ–±—ã: {str(e)}")
        return None

def chat_with_context(user_question, context, complaint_text, chat_history):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–∞—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
    try:
        prompt = CHAT_PROMPT.format(
            context=context,
            complaint_text=complaint_text,
            chat_history=chat_history,
            user_question=user_question
        )
        
        model = genai.GenerativeModel('gemini-2.0-flash-lite')
        
        generation_config = genai.types.GenerationConfig(
            temperature=0.7,
            top_p=0.9,
            top_k=40
        )
        
        response = model.generate_content(
            prompt,
            generation_config=generation_config
        )
        
        return response.text
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –≤ —á–∞—Ç–µ: {str(e)}")
        return None

def main():
    st.set_page_config(
        page_title="–Æ—Ä–∏—Å—Ç AI: –ù–∞–¥–∑–æ—Ä–Ω–∞—è –∂–∞–ª–æ–±–∞ –≤ –í–° –†–§",
        page_icon="‚öñÔ∏è",
        layout="wide"
    )
    
    st.title("‚öñÔ∏è –Æ—Ä–∏—Å—Ç AI: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã –≤ –í–µ—Ä—Ö–æ–≤–Ω—ã–π —Å—É–¥ –†–§")
    st.markdown("–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –Ω–∞–¥–∑–æ—Ä–Ω—É—é –∂–∞–ª–æ–±—É –ø–æ –¥–µ–ª—É –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏–∏ —Å –ø–æ–º–æ—â—å—é AI")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è session_state
    if 'current_step' not in st.session_state:
        st.session_state.current_step = 1  # 1: –∑–∞–≥—Ä—É–∑–∫–∞, 2: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, 3: —Ä–µ–∑—É–ª—å—Ç–∞—Ç, 4: —á–∞—Ç
    
    if 'context' not in st.session_state:
        st.session_state.context = ""
    
    if 'complaint_parts' not in st.session_state:
        st.session_state.complaint_parts = {}
    
    if 'full_complaint' not in st.session_state:
        st.session_state.full_complaint = ""
    
    if 'chat_history' not in st.session_state:
        st.session_state.chat_history = ""
    
    if 'uploaded_files' not in st.session_state:
        st.session_state.uploaded_files = []
    
    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if st.session_state.current_step == 1:
        st.header("1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –¥–µ–ª—É")
        
        st.info("""
        **–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–≤ —Ñ–æ—Ä–º–∞—Ç–µ DOCX):**
        - –í—Å–µ —Å—É–¥–µ–±–Ω—ã–µ –∞–∫—Ç—ã –ø–æ –¥–µ–ª—É
        - –ü—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞—è–≤–∏—Ç–µ–ª—è  
        - –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∞–≤–æ–≤–µ–¥–æ–≤
        - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        - –®–∞–±–ª–æ–Ω –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        """)
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        uploaded_files = st.file_uploader(
            "–í—ã–±–µ—Ä–∏—Ç–µ DOCX —Ñ–∞–π–ª—ã",
            type=['docx'],
            accept_multiple_files=True,
            help="–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"
        )
        
        if uploaded_files:
            st.session_state.uploaded_files = uploaded_files
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            st.subheader("–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:")
            for file in uploaded_files:
                st.write(f"üìÑ {file.name} ({file.size} –±–∞–π—Ç)")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–æ–≤
            if st.button("üìÇ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã", type="primary"):
                with st.spinner("–ß–∏—Ç–∞—é –¥–æ–∫—É–º–µ–Ω—Ç—ã..."):
                    context = extract_text_from_uploaded_files(uploaded_files)
                    
                    if context:
                        st.session_state.context = context
                        st.success(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(uploaded_files)} —Ñ–∞–π–ª–æ–≤")
                        
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                        with st.expander("üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"):
                            st.text_area("–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:", context[:5000] + "..." if len(context) > 5000 else context, height=300)
                        
                        st.session_state.current_step = 2
                        st.rerun()
                    else:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
        
        # –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if st.button("üöÄ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"):
            st.session_state.context = "–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
            st.session_state.current_step = 2
            st.rerun()
    
    # –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∂–∞–ª–æ–±—ã
    elif st.session_state.current_step == 2:
        st.header("2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã")
        
        if not st.session_state.context:
            st.error("–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ —à–∞–≥—É 1.")
            if st.button("‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"):
                st.session_state.current_step = 1
                st.rerun()
            return
        
        st.info("–ñ–∞–ª–æ–±–∞ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ —á–∞—Å—Ç—è–º —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å—Ç–∏ –∂–∞–ª–æ–±—ã –∏ –∏—Ö –ø–æ—Ä—è–¥–æ–∫
        complaint_parts = [
            ("factual", "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–µ–ª–∞", FACTUAL_CIRCUMSTANCES_PROMPT),
            ("legal_issues", "–ü—Ä–∞–≤–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞", LEGAL_ISSUES_PROMPT),
            ("applicant_position", "–ü—Ä–∞–≤–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –∑–∞—è–≤–∏—Ç–µ–ª—è", APPLICANT_POSITION_PROMPT),
            ("petition", "–ü—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å", PETITIONARY_PART_PROMPT)
        ]
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        generated_count = sum(1 for part_id, _, _ in complaint_parts if part_id in st.session_state.complaint_parts)
        total_parts = len(complaint_parts)
        
        # –ï—Å–ª–∏ –≤—Å–µ —á–∞—Å—Ç–∏ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        if generated_count >= total_parts:
            st.session_state.current_step = 3
            st.rerun()
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–Ω–æ–π —á–∞—Å—Ç–∏
        current_part_index = generated_count
        if current_part_index < total_parts:
            part_id, part_name, prompt_template = complaint_parts[current_part_index]
            
            status_text.text(f"–ì–µ–Ω–µ—Ä–∏—Ä—É—é: {part_name}...")
            progress_bar.progress(current_part_index / total_parts)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            generated_parts_text = "\n\n".join([
                f"=== {name} ===\n{text}" 
                for (pid, name, _), text in zip(
                    complaint_parts[:current_part_index], 
                    [st.session_state.complaint_parts.get(pid, "") for pid, _, _ in complaint_parts[:current_part_index]]
                )
            ])
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç—å
            with st.spinner(f"–ì–µ–Ω–µ—Ä–∏—Ä—É—é {part_name}..."):
                part_text = generate_complaint_part(
                    prompt_template,
                    st.session_state.context,
                    generated_parts_text
                )
                
                if part_text:
                    st.session_state.complaint_parts[part_id] = part_text
                    st.success(f"‚úÖ {part_name} —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —á–∞—Å—Ç—å
                    with st.expander(f"üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä: {part_name}"):
                        st.text_area("", part_text, height=300, key=f"view_{part_id}")
                    
                    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ {part_name}")
        
        # –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
        st.divider()
        st.subheader("–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —á–∞—Å—Ç–∏"):
                st.session_state.complaint_parts = {}
                st.rerun()
        
        with col2:
            if st.button("‚è© –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É"):
                st.session_state.current_step = 3
                st.rerun()
        
        with col3:
            if st.button("üí¨ –ü–µ—Ä–µ–π—Ç–∏ –∫ —á–∞—Ç—É"):
                st.session_state.current_step = 4
                st.rerun()
    
    # –®–∞–≥ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç - –ø–æ–ª–Ω–∞—è –∂–∞–ª–æ–±–∞
    elif st.session_state.current_step == 3:
        st.header("3. –ì–æ—Ç–æ–≤–∞—è –Ω–∞–¥–∑–æ—Ä–Ω–∞—è –∂–∞–ª–æ–±–∞")
        
        # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—É—é –∂–∞–ª–æ–±—É
        full_complaint_parts = []
        
        complaint_structure = [
            ("factual", "–§–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê –î–ï–õ–ê"),
            ("legal_issues", "–ü–†–ê–í–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê–¢–ò–ö–ê –î–ï–õ–ê"),
            ("applicant_position", "–ü–†–ê–í–û–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø –ó–ê–Ø–í–ò–¢–ï–õ–Ø"),
            ("petition", "–ü–†–û–°–ò–¢–ï–õ–¨–ù–ê–Ø –ß–ê–°–¢–¨")
        ]
        
        for part_id, part_title in complaint_structure:
            if part_id in st.session_state.complaint_parts:
                full_complaint_parts.append(f"{part_title}\n\n{st.session_state.complaint_parts[part_id]}")
        
        st.session_state.full_complaint = "\n\n" + "\n\n" + "="*50 + "\n\n".join(full_complaint_parts)
        
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª–Ω—É—é –∂–∞–ª–æ–±—É
        st.text_area("–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞–¥–∑–æ—Ä–Ω–æ–π –∂–∞–ª–æ–±—ã:", st.session_state.full_complaint, height=600)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        word_count = len(st.session_state.full_complaint.split())
        st.sidebar.header("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        st.sidebar.write(f"–û–±—â–∏–π –æ–±—ä–µ–º: {word_count} —Å–ª–æ–≤")
        st.sidebar.write(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(st.session_state.uploaded_files)}")
        st.sidebar.write(f"–†–∞–∑–¥–µ–ª–æ–≤ –∂–∞–ª–æ–±—ã: {len(st.session_state.complaint_parts)}")
        
        # –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        st.divider()
        st.header("üíæ –≠–∫—Å–ø–æ—Ä—Ç –∂–∞–ª–æ–±—ã")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–∞–∫ TXT
            b64_txt = base64.b64encode(st.session_state.full_complaint.encode()).decode()
            href_txt = f'<a href="data:file/txt;base64,{b64_txt}" download="–Ω–∞–¥–∑–æ—Ä–Ω–∞—è_–∂–∞–ª–æ–±–∞_–í–°_–†–§.txt">üì• –°–∫–∞—á–∞—Ç—å –∫–∞–∫ TXT</a>'
            st.markdown(href_txt, unsafe_allow_html=True)
        
        with col2:
            # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            if st.button("üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞"):
                st.code(st.session_state.full_complaint, language="markdown")
                st.success("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!")
        
        # –ù–∞–≤–∏–≥–∞—Ü–∏—è
        st.divider()
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"):
                st.session_state.current_step = 2
                st.rerun()
        
        with col2:
            if st.button("üîÑ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∂–∞–ª–æ–±—É"):
                for key in list(st.session_state.keys()):
                    if key != 'current_step':
                        del st.session_state[key]
                st.session_state.current_step = 1
                st.rerun()
        
        with col3:
            if st.button("üí¨ –û–±—Å—É–¥–∏—Ç—å –≤ —á–∞—Ç–µ ‚Üí"):
                st.session_state.current_step = 4
                st.rerun()
    
    # –®–∞–≥ 4: –ß–∞—Ç —Å AI
    elif st.session_state.current_step == 4:
        st.header("4. –ß–∞—Ç —Å AI-—é—Ä–∏—Å—Ç–æ–º")
        
        st.info("""
        **–û–±—Å—É–∂–¥–∞–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∂–∞–ª–æ–±—É –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å AI-—é—Ä–∏—Å—Ç–æ–º.**
        –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ:
        - –ü—Ä–∞–≤–æ–≤—ã–º –∞—Å–ø–µ–∫—Ç–∞–º –¥–µ–ª–∞
        - –î–æ—Ä–∞–±–æ—Ç–∫–µ –∂–∞–ª–æ–±—ã
        - –°—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ
        - –ü—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º
        """)
        
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
        chat_container = st.container()
        
        with chat_container:
            if st.session_state.chat_history:
                st.markdown("### –ò—Å—Ç–æ—Ä–∏—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è")
                st.text_area("", st.session_state.chat_history, height=400, key="chat_history_display")
        
        # –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
        st.divider()
        user_question = st.text_area(
            "–í–∞—à –≤–æ–ø—Ä–æ—Å –∫ AI-—é—Ä–∏—Å—Ç—É:",
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫–∏–µ –µ—â–µ –ø—Ä–∞–≤–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∂–∞–ª–æ–±–µ? –ò–ª–∏: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –ø–æ –ø–æ–¥–æ–±–Ω—ã–º –¥–µ–ª–∞–º...",
            height=100
        )
        
        col1, col2 = st.columns([1, 4])
        
        with col1:
            if st.button("üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å", type="primary"):
                if user_question.strip():
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ –∏—Å—Ç–æ—Ä–∏—é
                    st.session_state.chat_history += f"\n\nüë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨:\n{user_question}\n\n"
                    
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                    with st.spinner("AI-—é—Ä–∏—Å—Ç —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç..."):
                        response = chat_with_context(
                            user_question,
                            st.session_state.context,
                            st.session_state.full_complaint,
                            st.session_state.chat_history
                        )
                        
                        if response:
                            st.session_state.chat_history += f"‚öñÔ∏è AI-–Æ–†–ò–°–¢:\n{response}\n"
                            st.rerun()
                        else:
                            st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI-—é—Ä–∏—Å—Ç–∞")
                else:
                    st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å")
        
        with col2:
            if st.button("üßπ –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"):
                st.session_state.chat_history = ""
                st.rerun()
        
        # –ù–∞–≤–∏–≥–∞—Ü–∏—è
        st.divider()
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∂–∞–ª–æ–±–µ"):
                st.session_state.current_step = 3
                st.rerun()
        
        with col2:
            if st.button("üîÑ –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"):
                for key in list(st.session_state.keys()):
                    del st.session_state[key]
                st.session_state.current_step = 1
                st.rerun()

    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    st.sidebar.header("‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏")
    st.sidebar.info("""
    **–Æ—Ä–∏—Å—Ç AI** –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞–¥–∑–æ—Ä–Ω—É—é –∂–∞–ª–æ–±—É –≤ –í–µ—Ä—Ö–æ–≤–Ω—ã–π —Å—É–¥ –†–§ –ø–æ –¥–µ–ª–∞–º –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö.
    
    **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
    - –ê–Ω–∞–ª–∏–∑ —Å—É–¥–µ–±–Ω—ã—Ö –∞–∫—Ç–æ–≤ –∏ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∂–∞–ª–æ–±—ã
    - –£—á–µ—Ç –ø—Ä–∞–≤–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π
    - –ß–∞—Ç —Å AI-—é—Ä–∏—Å—Ç–æ–º –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
    
    **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:** DOCX
    """)
    
    st.sidebar.header("üéØ –°–æ–≤–µ—Ç—ã")
    st.sidebar.info("""
    - –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –≤—Å–µ –∏–º–µ—é—â–∏–µ—Å—è –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ –¥–µ–ª—É
    - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Ç –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∂–∞–ª–æ–±—É –ø–µ—Ä–µ–¥ –ø–æ–¥–∞—á–µ–π
    - –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    """)

if __name__ == "__main__":
    main()
